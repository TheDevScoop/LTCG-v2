name: Remotion PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  render-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build PR-driven Remotion props
        id: props
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          node <<'NODE'
          const fs = require("node:fs");

          const songs = [
            "THEME.mp3",
            "THEME2.mp3",
            "THEMEREMIX.mp3",
            "FREAK.mp3",
            "GEEK.mp3",
            "GOODIE.mp3",
            "NERDS.mp3",
            "DROPOUT.mp3",
          ];

          const prNumber = Number(process.env.PR_NUMBER || "0");
          const prTitle = String(process.env.PR_TITLE || "LTCG update");

          const sanitize = (value, max) =>
            value
              .replace(/[\r\n]+/g, " ")
              .replace(/[^a-zA-Z0-9 #:&!?.,'"/-]/g, "")
              .slice(0, max)
              .trim();

          const song = songs[Math.abs(prNumber) % songs.length];
          const hookTitle = sanitize(prTitle, 48) || "LTCG UPDATE";
          const props = {
            themeTrack: `lunchtable/soundtrack/${song}`,
            durationSec: 24,
            comicIntensity: "full",
            copyPack: {
              hook: `PR #${prNumber}: ${hookTitle}`.toUpperCase(),
              subhook: "AUTO PREVIEW RENDER",
              midA: "BUILD YOUR CLIQUE",
              midB: "CHAIN COMBOS. BREAK THE META.",
              ctaTop: "CONTROL THE CHAOS",
              ctaMain: "PLAY LUNCHTABLE TCG",
            },
          };

          fs.mkdirSync("video/out", {recursive: true});
          fs.writeFileSync("video/out/pr-preview-props.json", JSON.stringify(props));

          const outputFile = `ltcg-pr-${prNumber}-preview.mp4`;
          const stillFile = `ltcg-pr-${prNumber}-preview.jpg`;
          const output = process.env.GITHUB_OUTPUT;
          if (output) {
            fs.appendFileSync(output, `song=${song}\n`);
            fs.appendFileSync(output, `output_file=${outputFile}\n`);
            fs.appendFileSync(output, `still_file=${stillFile}\n`);
          }
          NODE

      - name: Render promo preview
        run: |
          cd video
          PROPS_JSON="$(cat out/pr-preview-props.json)"
          bunx remotion render src/index.ts LTCGComicPromo24 "out/${{ steps.props.outputs.output_file }}" \
            --codec=h264 \
            --crf=26 \
            --pixel-format=yuv420p \
            --concurrency=2 \
            --props="$PROPS_JSON"
          bunx remotion still src/index.ts LTCGComicPromo24 "out/${{ steps.props.outputs.still_file }}" \
            --frame=150 \
            --props="$PROPS_JSON"

      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: remotion-pr-preview-${{ github.event.pull_request.number }}
          path: |
            video/out/${{ steps.props.outputs.output_file }}
            video/out/${{ steps.props.outputs.still_file }}
            video/out/pr-preview-props.json
          if-no-files-found: error

      - name: Summary
        run: |
          {
            echo "### Remotion PR Preview";
            echo "";
            echo "- Output: \`video/out/${{ steps.props.outputs.output_file }}\`";
            echo "- Soundtrack: \`${{ steps.props.outputs.song }}\`";
            echo "- Artifact: \`remotion-pr-preview-${{ github.event.pull_request.number }}\`";
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upsert PR comment
        if: ${{ github.event.pull_request.head.repo.fork == false }}
        uses: actions/github-script@v7
        env:
          OUTPUT_FILE: ${{ steps.props.outputs.output_file }}
          STILL_FILE: ${{ steps.props.outputs.still_file }}
          SOUNDTRACK: ${{ steps.props.outputs.song }}
          ARTIFACT_NAME: remotion-pr-preview-${{ github.event.pull_request.number }}
        with:
          script: |
            const marker = '<!-- remotion-pr-preview-comment -->';
            const issue_number = context.payload.pull_request.number;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const artifactsResp = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
              per_page: 100,
            });
            const artifact = artifactsResp.data.artifacts.find(
              (a) => a.name === process.env.ARTIFACT_NAME,
            );
            const artifactUrl = artifact
              ? `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}/artifacts/${artifact.id}`
              : runUrl;

            const body = [
              marker,
              '## Remotion PR Preview',
              '',
              `- Soundtrack: \`${process.env.SOUNDTRACK}\``,
              `- Video: \`video/out/${process.env.OUTPUT_FILE}\``,
              `- Still: \`video/out/${process.env.STILL_FILE}\``,
              `- Artifact: \`${process.env.ARTIFACT_NAME}\``,
              `- Run: ${runUrl}`,
              `- Download: ${artifactUrl}`,
              '',
              'Download the artifact from this workflow run to review the render.'
            ].join('\n');

            const {data: comments} = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((c) => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body,
              });
            }
